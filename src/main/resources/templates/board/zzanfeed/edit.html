<!DOCTYPE html>
<html lang="en"
      layout:decorate="~{common/layouts/userDefault}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>ì „í†µìˆ  ìµœì €ê°€ ë¹„êµ ì»¤ë®¤ë‹ˆí‹°! ìˆ ê¸°ë¡œìš´ í•œ ì”</title>
    <script src="https://unpkg.com/@yaireo/tagify"></script>
    <script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
    <link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css"/>
    <link href="/board/zzanfeed/edit.css" rel="stylesheet">
</head>
<body>
<div class="my-container" layout:fragment="content">
    <input accept="image/*" id="thumbnail" name="thumbnail" type="file">
    <div class="cover-upload-container" id="coverPreview"
         th:style="'background-image: url(' + ${'https://kr.object.ncloudstorage.com/sulbao-file/' + thumbnail} + '); background-size: cover; background-position: center; color: transparent;'">
        ì»¤ë²„ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.
        <div class="upload-button-container">
            <button class="upload-button" id="uploadButton">
                ì»¤ë²„ì‚¬ì§„ ì¶”ê°€í•˜ê¸°
            </button>
        </div>
    </div>

    <div class="title-container">
        <div class="input-group">
            <label for="postTitle"></label>
            <input class="form-control" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." th:value="${post.title}" type="text">
        </div>
    </div>

    <div class="hashtag-container">
        <input class='some_class_name' name='tags' placeholder='í•´ì‹œíƒœê·¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.'>
    </div>

    <div class="editor-wrapper-container">
        <th:block th:each="content : ${contents}">
            <div class="editor-wrapper">
                <div class="square-box"
                     th:style="'background-image: url(' + ${'https://kr.object.ncloudstorage.com/sulbao-file/' + content.image} + '); background-size: cover; background-position: center; color: transparent;'"
                >
                    <input class="file-input" multiple style="display: none;" type="file"/>
                    <div class="upload-content">
                        <div class="camera-icon" th:if="${content.image == null}">ğŸ“·</div>
                        <p th:if="${content.image == null}">ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                        <p>10ì¥ê¹Œì§€ ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.</p>
                        <button class="upload-button" onclick="uploadImage(this)">PCì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                </div>
                <div class="editor-container">
                    <div class="summernote" th:text="${content.text}"></div>
                </div>
            </div>
        </th:block>
    </div>

    <div class="add-wrapper">
        <div class="square-box add-box" onclick="addEditorWrapper()">
            <div class="add-content">+</div>
        </div>
    </div>

    <div class="submit-wrapper">
        <button class="submit-button" onclick="submitContent()">ë“±ë¡í•˜ê¸°</button>
    </div>

    <script th:inline="javascript">
        $('#uploadButton').click(function () {
            $('#thumbnail').click();
        });

        $('#thumbnail').change(function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#coverPreview').css({
                        'background-image': `url(${e.target.result})`,
                        'background-size': 'cover',
                        'background-position': 'center',
                        'color': 'transparent'
                    });
                }
                reader.readAsDataURL(file);
            }
        });

        let input = document.querySelector('input[name="tags"]');

        let whitelist = [
            "#ë§‰ê±¸ë¦¬", "#ì†Œì£¼", "#ì²­ì£¼", "#ì™€ì¸", "#ì „í†µì£¼", "#ì£¼ë§‰", "#ìˆ ì§‘", "#ì „í†µì£¼ì¶”ì²œ",
            "#ì „í†µì£¼ë§›ì§‘", "#ë§‰ê±¸ë¦¬ë§›ì§‘", "#ì†Œì£¼ë§›ì§‘", "#ì²­ì£¼ë§›ì§‘", "#í•œì”í•©ì‹œë‹¤", "#ìˆ ìë¦¬",
            "#ìˆ ì•ˆì£¼", "#ìˆ í•œì”", "#ì „í†µì£¼ìŠ¤íƒ€ê·¸ë¨", "#ìˆ ì´ì•¼ê¸°", "#ì „í†µì£¼ì‚¬ë‘", "#ë§‰ê±¸ë¦¬ì‚¬ë‘",
            "#ì†Œì£¼ì‚¬ë‘", "#ì²­ì£¼ì‚¬ë‘", "#í•œì”ì˜ì—¬ìœ ", "#ìˆ ê³¼í•¨ê»˜", "#ì „í†µì£¼ì—¬í–‰", "#ì „í†µì£¼ë¬¸í™”",
            "#ì „í†µì£¼ì¶•ì œ", "#ì „í†µì£¼í•œì”", "#ì „í†µì£¼ì—­ì‚¬", "#ë§‰ê±¸ë¦¬í•œì”", "#ì†Œì£¼í•œì”", "#ì²­ì£¼í•œì”",
            "#ìˆ ê³¼ì „í†µ", "#ì „í†µì£¼ê¸°í–‰", "#ìˆ í•œì”ì–´ë•Œ", "#í•œì”ì˜í–‰ë³µ", "#ì „í†µì£¼ì •ëª¨", "#ì „í†µì£¼ì¼ê¸°",
            "#ìˆ ì‚¬ë‘", "#ë§‰ê±¸ë¦¬ì¼ê¸°", "#ì†Œì£¼ì¼ê¸°", "#ì²­ì£¼ì¼ê¸°", "#ì „í†µì£¼í•œìƒ", "#ìˆ ê³¼ë¬¸í™”",
            "#ìˆ ê³¼ì´ì•¼ê¸°", "#ìˆ ì´ì•¼ê¸°ë‚˜ëˆ„ê¸°", "#ì „í†µì£¼ì¶”ì²œë§›ì§‘", "#ë§‰ê±¸ë¦¬ì¶”ì²œë§›ì§‘", "#ì†Œì£¼ì¶”ì²œë§›ì§‘",
            "#ì²­ì£¼ì¶”ì²œë§›ì§‘", "#ìˆ ê³¼ì˜ì‹œê°„", "#ì „í†µì£¼ì´ì•¼ê¸°", "#ì „í†µì£¼ì™€í•¨ê»˜", "#ë§‰ê±¸ë¦¬ì™€í•¨ê»˜",
            "#ì†Œì£¼ì™€í•¨ê»˜", "#ì²­ì£¼ì™€í•¨ê»˜", "#ìˆ ìë¦¬ê°€ì¢‹ì€ê³³", "#ì „í†µì£¼ê´€ê´‘", "#ì „í†µì£¼ì²´í—˜",
            "#ìˆ ê³¼ì „í†µë¬¸í™”", "#ìˆ ë¡œì—¬í–‰", "#ì „í†µì£¼ì—¬í–‰ê¸°", "#ìˆ ê³¼ëª…ì†Œ", "#ì „í†µì£¼ëª…ì†Œ", "#ë§‰ê±¸ë¦¬ëª…ì†Œ",
            "#ì†Œì£¼ëª…ì†Œ", "#ì²­ì£¼ëª…ì†Œ", "#ì „í†µì£¼ë§›ì§‘íƒë°©", "#ìˆ ìë¦¬ì¶”ì²œ", "#ìˆ ìë¦¬íŒ"
        ];

        let tagify = new Tagify(input, {
            whitelist: whitelist,
            maxTags: 10,
            dropdown: {
                maxItems: 20,
                classname: "tags-look",
                enabled: 0,
                closeOnSelect: false
            }
        })

        let initialTags = [[${tags}]];
        tagify.addTags(initialTags);

        $(document).ready(function () {
            $('.summernote').summernote({
                lang: 'ko-KR',
                height: 180,
                disableResizeEditor: true
            });

            const summernoteEditors = document.querySelectorAll('.summernote');
            [[${contents}]].forEach((content, index) => {
                $(summernoteEditors[index]).summernote({
                    lang: 'ko-KR',
                    height: 180,
                    disableResizeEditor: true
                });
                $(summernoteEditors[index]).summernote('code', content.text);
            });
        });

        function addEditorWrapper() {
            const newWrapper = `
        <div class="editor-wrapper">
            <div class="square-box">
            <input class="file-input" multiple style="display: none;" type="file"/>
                <div class="upload-content">
                    <div class="camera-icon">ğŸ“·</div>
                    <p>ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                    <p>10ì¥ê¹Œì§€ ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”</p>
                    <button class="upload-button" onclick="uploadImage(this)">PCì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
            </div>
            <div class="editor-container">
                <div class="summernote"></div>
            </div>
        </div>
    `;

            $(newWrapper).insertBefore('.add-wrapper');

            $('.summernote').last().summernote({
                height: 180,
                disableResizeEditor: true
            });
        }

        function uploadImage(button) {
            const squareBox = $(button).closest('.square-box');
            const fileInput = squareBox.find('.file-input');

            fileInput.click();
            fileInput.on('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        squareBox.css({
                            'background-image': `url(${e.target.result})`,
                            'background-size': 'cover',
                            'background-position': 'center',
                            'color': 'transparent'
                        });
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        function submitContent() {
            let formData = new FormData();

            formData.append('title', document.getElementById('postTitle').value);

            let tags = tagify.value.map(tag => tag.value);
            tags.forEach(tag => formData.append('tags', tag));

            const thumbnailFile = document.getElementById('thumbnail').files[0];
            if (thumbnailFile != null) {
                formData.append('thumbnail', thumbnailFile);
            }

            const contentImages = document.querySelectorAll('.file-input');
            contentImages.forEach((input, index) => {
                if (input.files.length === 0) {
                    formData.append('contentImages', new Blob());
                } else {
                    for (let i = 0; i < input.files.length; i++) {
                        formData.append('contentImages', input.files[i]);
                    }
                }
            });

            const contents = document.querySelectorAll('.summernote');
            contents.forEach((editor, index) => {
                formData.append('contents', $(editor).summernote('code'));
            });

            $.ajax({
                url: `/zzanfeeds/edit/[[${post.getId()}]]`,
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (postId) {
                    location.href = `/zzanfeeds/[[${post.getId()}]]`;
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    </script>
</div>
</body>
</html>